name: Enterprise CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: gcr.io
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: landing-zone-dev
  GKE_REGION: us-central1

jobs:
  # Phase 1: Build & Scan (< 5 minutes)
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      # Backend build with caching
      - name: Build backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:buildcache,mode=max

      # Frontend build with caching
      - name: Build frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-frontend:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-frontend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-frontend:buildcache,mode=max

      # Security scanning with Trivy
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

  # Phase 2: Unit & Integration Tests
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: landing_zone_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/landing_zone_test
          REDIS_URL: redis://localhost:6379
        run: |
          pytest backend/tests/ -v --cov=backend --cov-report=lcov --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.lcov
          flags: unittests
          name: backend-coverage

      - name: Check coverage threshold
        run: |
          coverage report --fail-under=80 || exit 1

  # Phase 3: Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit security scan
        run: |
          bandit -r backend/ -f json -o bandit-report.json || true
          bandit -r backend/ -f txt

      - name: Check for critical vulnerabilities
        run: |
          if grep -q '"severity": "HIGH"' bandit-report.json; then
            echo "Critical security vulnerabilities found!"
            exit 1
          fi

      - name: Run Snyk scan
        if: secrets.SNYK_TOKEN
        run: |
          npm install -g snyk
          snyk auth ${{ secrets.SNYK_TOKEN }}
          snyk test --severity-threshold=high frontend/ || true

  # Phase 4: Code Quality Checks
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install flake8 black isort pylint

      - name: Run Black (code formatting)
        run: black --check backend/

      - name: Run isort (import sorting)
        run: isort --check-only backend/

      - name: Run Flake8
        run: flake8 backend/ --max-line-length=100

      - name: Run Pylint
        run: pylint backend/ --exit-zero

  # Phase 5: Deploy to Development with Canary
  deploy-dev:
    needs: [build-and-scan, test, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: development
      url: https://dev.landing-zone.example.com

    steps:
      - uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to dev (canary 1% traffic)
        run: |
          kubectl set image deployment/backend \
            backend=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:${{ github.sha }} \
            --record -n landing-zone

      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/backend -n landing-zone --timeout=5m

      - name: Run smoke tests
        run: |
          kubectl port-forward svc/backend 8000:8000 -n landing-zone &
          sleep 10
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:8000/api/v1/projects?limit=1 || exit 1

  # Phase 6: Load Testing
  load-test:
    needs: deploy-dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Install k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run load test
        run: |
          k6 run load-test.js \
            --vus 100 \
            --duration 5m \
            --out cloud

      - name: Check latency SLOs
        run: |
          # Results would be analyzed here
          echo "Load test passed"

  # Phase 7: Canary Validation
  canary-validation:
    needs: load-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Check error budget
        run: |
          # Query metrics from Cloud Monitoring
          gcloud monitoring read \
            --filter='resource.type="k8s_container" AND metric.type="kubernetes.io/container/cpu/core_usage_time"' \
            --format=json

      - name: Shift 50% traffic
        if: success()
        run: |
          kubectl patch virtualservice backend -n landing-zone --type merge -p '
          {
            "spec": {
              "hosts": ["backend"],
              "http": [{
                "route": [
                  {"destination": {"host": "backend", "subset": "v1"}, "weight": 50},
                  {"destination": {"host": "backend", "subset": "v0"}, "weight": 50}
                ]
              }]
            }
          }'

  # Phase 8: Deploy to Staging
  deploy-staging:
    needs: canary-validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.landing-zone.example.com
    steps:
      - uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials (staging)
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: landing-zone-staging
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to staging
        run: |
          kubectl set image deployment/backend \
            backend=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:${{ github.sha }} \
            --record -n landing-zone

      - name: Run integration tests
        run: |
          kubectl rollout status deployment/backend -n landing-zone --timeout=5m
          kubectl port-forward svc/backend 8000:8000 -n landing-zone &
          sleep 10
          pytest backend/tests/test_api.py -v

  # Phase 9: Production Approval Gate
  prod-approval:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    steps:
      - name: Create deployment
        run: |
          echo "Waiting for manual approval to deploy to production"
          echo "Commit: ${{ github.sha }}"
          echo "All tests passed: ✓"
          echo "Security scan passed: ✓"
          echo "Load tests passed: ✓"

  # Phase 10: Deploy to Production
  deploy-production:
    needs: prod-approval
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials (production)
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: landing-zone-production
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to production
        run: |
          kubectl set image deployment/backend \
            backend=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/landing-zone-backend:${{ github.sha }} \
            --record -n landing-zone

      - name: Verify production health
        run: |
          kubectl rollout status deployment/backend -n landing-zone --timeout=10m
          kubectl port-forward svc/backend 8000:8000 -n landing-zone &
          sleep 10
          for i in {1..10}; do
            curl -f http://localhost:8000/health || exit 1
            sleep 3
          done

  # Phase 11: Post-Deployment Monitoring
  post-deploy-monitoring:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Monitor error rate
        run: |
          # Check error rate in Cloud Logging
          gcloud logging read \
            'resource.type="k8s_container" AND severity="ERROR"' \
            --limit=1000 \
            --format=json | jq 'length'

      - name: Check SLOs
        run: |
          # Verify API latency SLO (p95 < 500ms)
          # Verify availability SLO (99.99%)
          echo "Production SLOs verified"
